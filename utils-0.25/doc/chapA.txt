  
  [1XA [33X[0;0YAppendix[133X[101X
  
  [33X[0;0YIn order to deal with duplicate declarations and implementations of a global
  function  [10Xglob[110X,  the final sections of the library files [11Xoper.g[111X and [11Xglobal.g[111X
  have been modified as shown below.[133X
  
  [33X[0;0YThere are three changes:[133X
  
  [30X    [33X[0;6YThe  lists  [3XGLOBAL_REDECLARATION_LIST[103X,  [3XGLOBAL_REINSTALLATION_LIST[103X and
        [3XGLOBAL_REDECLARATION_COUNT[103X are initialized.[133X
  
  [30X    [33X[0;6YFunctions  [10XAllowGlobalRedeclaration[110X  and [10XAllowGlobalReinstallation[110X are
        added.  The  former  adds  function  names  (as  strings)  to the list
        [3XGLOBAL_REDECLARATION_LIST[103X,   while   the  latter  adds  the  functions
        themselves to the list [3XGLOBAL_REINSTALLATION_LIST[103X.[133X
  
  [30X    [33X[0;6YA  conditional  clause  is  inserted  into  the  implementation of the
        functions   [10XDeclareGlobalFunction[110X   and   [10XInstallGlobalFunction[110X  which
        prevent  their  application to [10Xglob[110X a second time, but ensures a first
        application.[133X
  
  [33X[0;0YThe additional and modified code in [11Xoper.g[111X is listed here.[133X
  
  [4X[32X  Example  [32X[104X
    [4X[28X[128X[104X
    [4X[28X#############################################################################[128X[104X
    [4X[28X##[128X[104X
    [4X[28X#F  AllowGlobalRedeclaration( <list> ) . . function(s) may be declared twice[128X[104X
    [4X[28X#F  AllowGlobalReinstallation( <list> ) . . . . . .  and implemented twice[128X[104X
    [4X[28X## [128X[104X
    [4X[28XBIND_GLOBAL( "GLOBAL_REDECLARATION_LIST",   [128X[104X
    [4X[28X    ShareSpecialObj([], "GLOBAL_REDECLARATION_LIST") );  [128X[104X
    [4X[28XBIND_GLOBAL( "GLOBAL_REINSTALLATION_LIST",  [128X[104X
    [4X[28X    ShareSpecialObj([], "GLOBAL_REINSTALLATION_LIST") );  [128X[104X
    [4X[28XBIND_GLOBAL( "GLOBAL_REDECLARATION_COUNT", [128X[104X
    [4X[28X    ShareSpecialObj([], "GLOBAL_REDECLARATION_COUNT") );  [128X[104X
    [4X[28X[128X[104X
    [4X[28XBIND_GLOBAL( "AllowGlobalRedeclaration", function( arg ) [128X[104X
    [4X[28X    local  L, pos, name, count;[128X[104X
    [4X[28X    ##  form the arguments into a list L [128X[104X
    [4X[28X    if LEN_LIST(arg) = 1 then [128X[104X
    [4X[28X        if IS_STRING_REP( arg[1] ) then [128X[104X
    [4X[28X            L := arg;[128X[104X
    [4X[28X        elif IS_LIST( arg[1] ) then [128X[104X
    [4X[28X            L := arg[1]; [128X[104X
    [4X[28X        else [128X[104X
    [4X[28X            L := [ ]; [128X[104X
    [4X[28X        fi;[128X[104X
    [4X[28X    else [128X[104X
    [4X[28X        L := arg;[128X[104X
    [4X[28X    fi;[128X[104X
    [4X[28X    for name in L do [128X[104X
    [4X[28X        ##  avoid duplicate entries in GLOBAL_REDECLARATION_LIST [128X[104X
    [4X[28X        pos := POS_LIST_DEFAULT( GLOBAL_REDECLARATION_LIST, name, 0 ); [128X[104X
    [4X[28X        if ( pos = fail ) then [128X[104X
    [4X[28X            ADD_LIST( GLOBAL_REDECLARATION_LIST, name ); [128X[104X
    [4X[28X            ##  has name been declared already? [128X[104X
    [4X[28X            if ISBOUND_GLOBAL( name ) then [128X[104X
    [4X[28X                count := 1; [128X[104X
    [4X[28X            else [128X[104X
    [4X[28X                count := 0;[128X[104X
    [4X[28X            fi; [128X[104X
    [4X[28X            ADD_LIST( GLOBAL_REDECLARATION_COUNT, count ); [128X[104X
    [4X[28X        fi;[128X[104X
    [4X[28X    od;[128X[104X
    [4X[28Xend );[128X[104X
    [4X[28X[128X[104X
    [4X[28XBIND_GLOBAL( "AllowGlobalReinstallation", function( arg ) [128X[104X
    [4X[28X    local  L, oper, posd, posi, name; [128X[104X
    [4X[28X    ##  form the arguments into a list L [128X[104X
    [4X[28X    if LEN_LIST(arg) = 1 then [128X[104X
    [4X[28X        if IS_FUNCTION( arg[1] ) then [128X[104X
    [4X[28X            L := arg;[128X[104X
    [4X[28X        elif IS_LIST( arg[1] ) then [128X[104X
    [4X[28X            L := arg[1]; [128X[104X
    [4X[28X        else [128X[104X
    [4X[28X            L := [ ]; [128X[104X
    [4X[28X        fi;[128X[104X
    [4X[28X    else [128X[104X
    [4X[28X        L := arg;[128X[104X
    [4X[28X    fi;[128X[104X
    [4X[28X    for oper in L do [128X[104X
    [4X[28X        ##  avoid duplicate entries in GLOBAL_REINSTALLATION_LIST [128X[104X
    [4X[28X        posi := POS_LIST_DEFAULT( GLOBAL_REINSTALLATION_LIST, oper, 0 ); [128X[104X
    [4X[28X        if ( ( posi = fail ) and IS_FUNCTION( oper ) ) then [128X[104X
    [4X[28X            ##  check that the two lists are consistently ordered [128X[104X
    [4X[28X            posi := LEN_LIST( GLOBAL_REINSTALLATION_LIST ) + 1; [128X[104X
    [4X[28X            name := NAME_FUNC( oper ); [128X[104X
    [4X[28X            posd := POS_LIST_DEFAULT( GLOBAL_REDECLARATION_LIST, name, 0 ); [128X[104X
    [4X[28X            if ( posd = posi ) then [128X[104X
    [4X[28X                ADD_LIST( GLOBAL_REINSTALLATION_LIST, oper ); [128X[104X
    [4X[28X            else [128X[104X
    [4X[28X                Error( "redeclaration and reinstallation lists inconsistent" );[128X[104X
    [4X[28X            fi;[128X[104X
    [4X[28X        fi;[128X[104X
    [4X[28X    od;[128X[104X
    [4X[28Xend );[128X[104X
    [4X[28X[128X[104X
    [4X[28X[128X[104X
    [4X[28X#############################################################################[128X[104X
    [4X[28X##[128X[104X
    [4X[28X#F  DeclareGlobalFunction( <name>, <info> ) . .  create a new global function[128X[104X
    [4X[28X#F  InstallGlobalFunction( <oper>, <func> )[128X[104X
    [4X[28X##[128X[104X
    [4X[28X##  Global functions of the &GAP; library must be distinguished from other[128X[104X
    [4X[28X##  global variables (see <C>variable.g</C>) because of the completion[128X[104X
    [4X[28X##  mechanism.[128X[104X
    [4X[28X##[128X[104X
    [4X[28X[128X[104X
    [4X[28XBIND_GLOBAL( "GLOBAL_FUNCTION_NAMES", [128X[104X
    [4X[28X    ShareSpecialObj([], "GLOBAL_FUNCTION_NAMES") );[128X[104X
    [4X[28X[128X[104X
    [4X[28XBIND_GLOBAL( "DeclareGlobalFunction", function( arg )[128X[104X
    [4X[28X    local   pos,  count,  name;[128X[104X
    [4X[28X[128X[104X
    [4X[28X    name := arg[1];[128X[104X
    [4X[28X    ## special case: redeclaration is permitted so increment count for 'name' [128X[104X
    [4X[28X    if ( name in GLOBAL_REDECLARATION_LIST ) then [128X[104X
    [4X[28X        pos := POS_LIST_DEFAULT( GLOBAL_REDECLARATION_LIST, name, 0 );   [128X[104X
    [4X[28X        count := GLOBAL_REDECLARATION_COUNT[pos] + 1; [128X[104X
    [4X[28X        GLOBAL_REDECLARATION_COUNT[pos] := count; [128X[104X
    [4X[28X        ## if already declared then there is nothing to do [128X[104X
    [4X[28X        if ISBOUND_GLOBAL( name ) then[128X[104X
    [4X[28X            return; [128X[104X
    [4X[28X        fi;[128X[104X
    [4X[28X    fi; [128X[104X
    [4X[28X    atomic GLOBAL_FUNCTION_NAMES do[128X[104X
    [4X[28X    ADD_SET( GLOBAL_FUNCTION_NAMES, IMMUTABLE_COPY_OBJ(name) );[128X[104X
    [4X[28X    od;[128X[104X
    [4X[28X    BIND_GLOBAL( name, NEW_OPERATION_ARGS( name ) ); [128X[104X
    [4X[28Xend );[128X[104X
    [4X[28X[128X[104X
    [4X[28XBIND_GLOBAL( "InstallGlobalFunction", function( arg )[128X[104X
    [4X[28X    local   oper,  info,  func,  pos;[128X[104X
    [4X[28X[128X[104X
    [4X[28X    if LEN_LIST(arg) = 3  then[128X[104X
    [4X[28X        oper := arg[1];[128X[104X
    [4X[28X        info := arg[2];[128X[104X
    [4X[28X        func := arg[3];[128X[104X
    [4X[28X    else[128X[104X
    [4X[28X        oper := arg[1];[128X[104X
    [4X[28X        func := arg[2];[128X[104X
    [4X[28X    fi;[128X[104X
    [4X[28X    if IS_STRING( oper ) then[128X[104X
    [4X[28X        oper := VALUE_GLOBAL( oper );[128X[104X
    [4X[28X    fi;[128X[104X
    [4X[28X    ## special case: reinstallation is permitted so check declaration number [128X[104X
    [4X[28X    if ( oper in GLOBAL_REINSTALLATION_LIST ) then [128X[104X
    [4X[28X        pos := POS_LIST_DEFAULT( GLOBAL_REINSTALLATION_LIST, oper, 0 );   [128X[104X
    [4X[28X        if ( GLOBAL_REDECLARATION_COUNT[pos] >= 2 ) then [128X[104X
    [4X[28X            ## there have been 2 declarations so this is a repeat installation [128X[104X
    [4X[28X            return; [128X[104X
    [4X[28X        fi; [128X[104X
    [4X[28X    fi;  [128X[104X
    [4X[28X    atomic readonly GLOBAL_FUNCTION_NAMES do[128X[104X
    [4X[28X    if NAME_FUNC(func) in GLOBAL_FUNCTION_NAMES then[128X[104X
    [4X[28X        Error("you cannot install a global function for another global ",[128X[104X
    [4X[28X              "function,\nuse `DeclareSynonym' instead!");[128X[104X
    [4X[28X    fi;[128X[104X
    [4X[28X    INSTALL_METHOD_ARGS( oper, func );[128X[104X
    [4X[28X    od;[128X[104X
    [4X[28Xend );[128X[104X
    [4X[28X[128X[104X
  [4X[32X[104X
  
  [33X[0;0YFor     functions     installed    directly    using    [10XBIND_GLOBAL[110X    lists
  [3XGLOBAL_REBINDING_LIST[103X  and [3XGLOBAL_REBINDING_COUNT[103X are used, and the function
  [10XAllowGlobalRebinding[110X  added. The additional and modified code in [11Xglobal.g[111X is
  listed here.[133X
  
  [4X[32X  Example  [32X[104X
    [4X[28X[128X[104X
    [4X[28XGLOBAL_REBINDING_LIST := [ ]; [128X[104X
    [4X[28XGLOBAL_REBINDING_COUNT := [ ]; [128X[104X
    [4X[28X[128X[104X
    [4X[28X#############################################################################[128X[104X
    [4X[28X##[128X[104X
    [4X[28X#F  BIND_GLOBAL ( <name>, <val> ) . . . . . .sets a global variable 'safely'[128X[104X
    [4X[28X##[128X[104X
    [4X[28X##  BIND_GLOBAL ( <name>, <val> ) sets the global variable named by[128X[104X
    [4X[28X##  the string <name> to the value <val>, provided it was previously[128X[104X
    [4X[28X##  unbound, and makes it read-only. This is intended to be the normal[128X[104X
    [4X[28X##  way to create and set "official" global variable (such as[128X[104X
    [4X[28X##  Operations and Categories)[128X[104X
    [4X[28X##[128X[104X
    [4X[28X  [128X[104X
    [4X[28XBIND_GLOBAL := function( name, val)[128X[104X
    [4X[28Xlocal   pos,  count; [128X[104X
    [4X[28X    ## special case: rebinding is permitted so increment count for 'name'  [128X[104X
    [4X[28X    if ( name in GLOBAL_REBINDING_LIST ) then [128X[104X
    [4X[28X        pos := POS_LIST_DEFAULT( GLOBAL_REBINDING_LIST, name, 0 );   [128X[104X
    [4X[28X        count := GLOBAL_REBINDING_COUNT[pos] + 1; [128X[104X
    [4X[28X        GLOBAL_REBINDING_COUNT[pos] := count; [128X[104X
    [4X[28X        ## if already bound then there is nothing to do [128X[104X
    [4X[28X        if ISBOUND_GLOBAL( name ) then [128X[104X
    [4X[28X            return; [128X[104X
    [4X[28X        fi;[128X[104X
    [4X[28X    fi; [128X[104X
    [4X[28X    if not REREADING and ISBOUND_GLOBAL( name ) then[128X[104X
    [4X[28X        if (IS_READ_ONLY_GLOBAL(name)) then[128X[104X
    [4X[28X            Error("BIND_GLOBAL: variable `", name, "' must be unbound");[128X[104X
    [4X[28X        else[128X[104X
    [4X[28X            Print("#W BIND_GLOBAL: variable `", name,"' already has a value\n");[128X[104X
    [4X[28X        fi;[128X[104X
    [4X[28X    fi;[128X[104X
    [4X[28X    ASS_GVAR(name, val);[128X[104X
    [4X[28X    MAKE_READ_ONLY_GLOBAL(name);[128X[104X
    [4X[28X    return val;[128X[104X
    [4X[28Xend;[128X[104X
    [4X[28X[128X[104X
    [4X[28X#############################################################################[128X[104X
    [4X[28X##[128X[104X
    [4X[28X#F  AllowGlobalRebinding( <list> ) . . function(s) may be BIND_GLOBAL'ed twice[128X[104X
    [4X[28X##[128X[104X
    [4X[28XBIND_GLOBAL( "AllowGlobalRebinding", function( arg ) [128X[104X
    [4X[28X    local  L, pos, name, val;[128X[104X
    [4X[28X    ##  form the arguments into a list L [128X[104X
    [4X[28X    if LEN_LIST(arg) = 1 then [128X[104X
    [4X[28X        if IS_STRING_REP( arg[1] ) then [128X[104X
    [4X[28X            L := arg;[128X[104X
    [4X[28X        elif IS_LIST( arg[1] ) then [128X[104X
    [4X[28X            L := arg[1]; [128X[104X
    [4X[28X        else [128X[104X
    [4X[28X            L := [ ]; [128X[104X
    [4X[28X        fi;[128X[104X
    [4X[28X    else [128X[104X
    [4X[28X        L := arg;[128X[104X
    [4X[28X    fi;[128X[104X
    [4X[28X    for name in L do [128X[104X
    [4X[28X        ##  avoid duplicate entries in GLOBAL_REBINDING_LIST [128X[104X
    [4X[28X        pos := POS_LIST_DEFAULT( GLOBAL_REBINDING_LIST, name, 0 ); [128X[104X
    [4X[28X        if ( pos = fail ) then [128X[104X
    [4X[28X            ADD_LIST( GLOBAL_REBINDING_LIST, name ); [128X[104X
    [4X[28X            ##  has 'name' been declared already? [128X[104X
    [4X[28X            if ISBOUND_GLOBAL( name ) then [128X[104X
    [4X[28X                val := 1; [128X[104X
    [4X[28X            else [128X[104X
    [4X[28X                val := 0;[128X[104X
    [4X[28X            fi; [128X[104X
    [4X[28X            ADD_LIST( GLOBAL_REBINDING_COUNT, val ); [128X[104X
    [4X[28X        fi;[128X[104X
    [4X[28X    od;[128X[104X
    [4X[28Xend );[128X[104X
    [4X[28X[128X[104X
  [4X[32X[104X
  
